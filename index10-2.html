<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>10. 비동기 동시성 프로그래밍 - 2</title>
</head>
<body>
  <script src="./js/js10.js"></script>

  ## 지연된 함수열을 병렬적으로 평가하기 - C.reduce, C.take

  <script>
    const C = {};
    function noop() {}
    const catchNoop = arr =>
    (arr.forEach(a => a instanceof Promise ? a.catch(noop) : a), arr);

    C.reduce = curry((f, acc, iter) => {
      const iter2 = catchNoop(iter ? [...iter] : [...acc]);
      // iter2.forEach(a => a.catch(function() {}));
      return iter ?
      reduce(f, acc, [...iter]) :
      reduce(f, [...acc])});

    // C.reduce = curry((f, acc, iter) => iter ?
    //   reduce(f, acc, [...iter]) : // 비동기가 일어나는 것을 제어하지 않고 대기된 함수들을 모두 다 실행함, 다시 reduce에서 묶을 것이기 때문에....
    //   reduce(f, [...acc]));

    C.take = curry((l, iter) => take(l, catchNoop([...iter])));

    C.takeAll = C.take(Infinity);

    C.map = curry(pipe(L.map, C.takeAll));
    
    C.filter = curry(pipe(L.filter, C.takeAll));

    const delay1000 = a => new Promise(resolve =>{
      console.log('hi');
      setTimeout(() => resolve(a), 1000)});

    // go([1, 2, 3, 4, 5],
    //   L.map(a => delay500(a * a)),
    //   L.filter(a => a % 2),
    //   C.take(2),
    //   C.reduce(add),
    //   console.log
    // )

    // C가 없다: 명령 자체를 덜 시키면서 부하를 줄이고 최적화(하나씩 실행)
    // C가 있다: 최대한 많은 자원을 써서 결과를 빨리 꺼내는 방향으로 처리
  </script>

  ## 즉시 병렬적으로 평가하기 - C.map, C.filter

  <script>
    // C.map(a => delay1000(a * a), [1, 2, 3, 4]).then(console.log);
    // C.filter(a => delay1000(a % 2), [1, 2, 3, 4]).then(console.log);
  </script>

  ## 즉시, 지연, Promise, 병렬적 조합하기

  <script>
    const delay500 = (a, name) => new Promise (resolve => {
      console.log(`${name}: ${a}`);
      setTimeout(() => resolve(a), 500);
    });

    console.time('');
    go([1, 2, 3, 4, 5, 6, 7, 8],
      L.map(a => delay500(a * a, 'map 1')),
      L.filter(a => delay500(a % 2, 'filter 2')),
      L.map(a => delay500(a + 1, 'map 3')),
      C.take(2),
      // reduce(add),
      console.log,
      _ => console.timeEnd('')
    );


  </script>
</body>
</html>